# Velociraptor Docker Compose Configuration
# Generated by Megaraptor MCP - {{ deployment_id }}
# Generated at: {{ generated_at }}

version: '3.8'

services:
  velociraptor:
    image: {{ velociraptor_image | default('velocidex/velociraptor:latest') }}
    container_name: velociraptor-{{ deployment_id }}
    restart: unless-stopped
    command: ["frontend", "-c", "/etc/velociraptor/server.config.yaml"]
    ports:
      - "{{ gui_port }}:{{ gui_port }}"
      - "{{ frontend_port }}:{{ frontend_port }}"
{% if monitoring_enabled %}
      - "{{ monitoring_port | default(8003) }}:{{ monitoring_port | default(8003) }}"
{% endif %}
    volumes:
      - ./config/server.config.yaml:/etc/velociraptor/server.config.yaml:ro
      - ./certs:/etc/velociraptor/certs:ro
      - velociraptor-data:/opt/velociraptor/data
      - velociraptor-logs:/opt/velociraptor/logs
    environment:
      - TZ={{ timezone | default('UTC') }}
{% if resource_limits %}
    deploy:
      resources:
        limits:
          memory: {{ resource_limits.memory | default('4g') }}
          cpus: '{{ resource_limits.cpus | default('2') }}'
{% endif %}
    labels:
      - "megaraptor.deployment_id={{ deployment_id }}"
      - "megaraptor.profile={{ profile }}"
      - "megaraptor.created_at={{ generated_at }}"
{% if auto_destroy_at %}
      - "megaraptor.auto_destroy_at={{ auto_destroy_at }}"
{% endif %}
    healthcheck:
      test: ["CMD", "curl", "-f", "-k", "https://localhost:{{ gui_port }}/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  velociraptor-data:
    name: velociraptor-data-{{ deployment_id }}
  velociraptor-logs:
    name: velociraptor-logs-{{ deployment_id }}

networks:
  default:
    name: velociraptor-network-{{ deployment_id }}
