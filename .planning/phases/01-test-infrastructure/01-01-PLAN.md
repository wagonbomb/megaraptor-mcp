---
phase: 01-test-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - tests/conftest.py
autonomous: true

must_haves:
  truths:
    - "pytest-check, jsonschema are available for import in tests"
    - "Module-scoped VelociraptorClient fixture establishes connection once per test module"
    - "Client fixture closes connection after module completes"
    - "Global client state is reset between tests"
  artifacts:
    - path: "pyproject.toml"
      provides: "Test infrastructure dependencies"
      contains: "pytest-check"
    - path: "tests/conftest.py"
      provides: "Enhanced client fixture with lifecycle management"
      exports: ["velociraptor_client"]
  key_links:
    - from: "tests/conftest.py"
      to: "megaraptor_mcp.client"
      via: "VelociraptorClient import and lifecycle"
      pattern: "from megaraptor_mcp.client import VelociraptorClient"
    - from: "tests/conftest.py"
      to: "tests/integration/test_dfir_tools.py"
      via: "fixture inheritance"
      pattern: "def velociraptor_client"
---

<objective>
Add test infrastructure dependencies and enhance the VelociraptorClient fixture with proper gRPC connection lifecycle management.

Purpose: Establish foundational patterns for all Phase 1 infrastructure - proper connection pooling prevents resource leaks, multiple assertions enable comprehensive DFIR validation, and schema validation ensures output correctness.

Output: Updated pyproject.toml with new dev dependencies, enhanced conftest.py with module-scoped client fixture that has explicit connect/close lifecycle.
</objective>

<execution_context>
@C:\Users\Meow\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Meow\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-test-infrastructure/01-RESEARCH.md

# Existing code to extend
@pyproject.toml
@tests/conftest.py
@src/megaraptor_mcp/client.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add test infrastructure dependencies</name>
  <files>pyproject.toml</files>
  <action>
Add the following packages to the `[project.optional-dependencies]` dev section:

```toml
dev = [
    "pytest>=7.0.0",
    "pytest-asyncio>=0.21.0",
    "pytest-timeout>=2.2.0",
    "pytest-check>=2.6.2",
    "jsonschema>=4.26.0",
]
```

These are additions to existing dev dependencies:
- pytest-check: Multiple assertions per test (critical for DFIR output validation - see all failures, not just first)
- jsonschema: VQL output schema validation (formal contract validation for AI assistant parsing)

Do NOT add pytest-docker yet - research indicates keeping existing subprocess approach for Phase 1.
  </action>
  <verify>
Run: `pip install -e ".[dev]"` and verify no errors.
Run: `python -c "import pytest_check; import jsonschema; print('OK')"` returns OK.
  </verify>
  <done>
pytest-check and jsonschema are importable after dev install.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance VelociraptorClient fixture with lifecycle management</name>
  <files>tests/conftest.py</files>
  <action>
Update the existing velociraptor_client fixture in tests/conftest.py to:

1. Keep module scope (already correct pattern)
2. Add explicit `client.connect()` call before yielding
3. Add explicit `client.close()` call in cleanup
4. Add `reset_client()` call to handle global client state
5. Add an autouse function-scoped fixture to reset global client state between tests

The module-scoped fixture should look like:
```python
@pytest.fixture(scope="module")
def velociraptor_client(docker_compose_up, velociraptor_api_config):
    """Create module-scoped Velociraptor client with lifecycle management.

    Reuses gRPC connection across all tests in a module to prevent
    connection exhaustion (gRPC channels should be long-lived).
    """
    if not docker_compose_up:
        pytest.skip("Docker infrastructure not available")

    from megaraptor_mcp.client import VelociraptorClient, reset_client
    from megaraptor_mcp.config import VelociraptorConfig

    config_path = velociraptor_api_config["config_path"]
    if not Path(config_path).exists():
        pytest.skip(f"API client config not found: {config_path}")

    config = VelociraptorConfig.from_config_file(config_path)
    client = VelociraptorClient(config)

    # Explicit connection
    client.connect()

    yield client

    # Explicit cleanup
    try:
        client.close()
    finally:
        reset_client()  # Reset global client state
```

Add the autouse fixture for test isolation:
```python
@pytest.fixture(autouse=True)
def reset_global_client_state():
    """Reset global client before each test for isolation.

    Mitigates global _client instance to prevent state leakage.
    """
    from megaraptor_mcp.client import reset_client
    reset_client()
    yield
    reset_client()
```

IMPORTANT: Do NOT import at top level - import inside fixture to avoid import errors when client module not available.
  </action>
  <verify>
Run existing integration tests: `pytest tests/integration/test_dfir_tools.py -v --timeout=120`
Tests should still pass (or skip if Docker not available).
Check that no new import errors are introduced.
  </verify>
  <done>
velociraptor_client fixture has explicit connect/close lifecycle.
reset_global_client_state autouse fixture exists.
Existing integration tests pass or skip appropriately.
  </done>
</task>

<task type="auto">
  <name>Task 3: Remove duplicate velociraptor_client from test_dfir_tools.py</name>
  <files>tests/integration/test_dfir_tools.py</files>
  <action>
The test_dfir_tools.py file currently defines its own `velociraptor_client` fixture (lines 28-54) that shadows the one in conftest.py. This creates confusion and prevents the enhanced lifecycle fixture from being used.

Remove the local `velociraptor_client` fixture from test_dfir_tools.py. The tests will then use the enhanced fixture from conftest.py automatically through pytest's fixture discovery.

Also remove the `event_loop` fixture (lines 20-25) as pytest-asyncio handles this automatically with asyncio_mode = "auto" in pyproject.toml.

After removal, the file should start with:
```python
"""Integration tests for DFIR tools against real Velociraptor server.

These tests require the Docker test infrastructure to be running.
Start with: ./scripts/test-lab.sh up

The tests verify that the MCP tools correctly interact with a real
Velociraptor server and enrolled client.
"""

import pytest

# These tests require Docker infrastructure
pytestmark = [pytest.mark.integration, pytest.mark.slow]


class TestClientManagement:
    ...
```

Remove any unused imports (asyncio, time, Path) after fixture removal.
  </action>
  <verify>
Run: `pytest tests/integration/test_dfir_tools.py -v --timeout=120`
Tests should pass using the conftest.py fixture.
Verify the file no longer has a local velociraptor_client fixture.
  </verify>
  <done>
test_dfir_tools.py uses conftest.py fixture exclusively.
No duplicate fixture definitions.
Tests pass with shared lifecycle-managed fixture.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Dependencies installed: `python -c "import pytest_check; import jsonschema; print('OK')"`
2. Fixture lifecycle correct: Add temporary debug print to conftest.py fixture, run 2 tests in same module, verify connect() called once
3. No duplicate fixtures: `grep -c "def velociraptor_client" tests/integration/test_dfir_tools.py` returns 0
4. Tests pass: `pytest tests/integration/test_dfir_tools.py -v --timeout=120` (or skip if Docker unavailable)
</verification>

<success_criteria>
- pytest-check and jsonschema importable after `pip install -e ".[dev]"`
- conftest.py has module-scoped velociraptor_client with explicit connect/close
- conftest.py has autouse reset_global_client_state fixture
- test_dfir_tools.py has no local velociraptor_client fixture
- Integration tests pass or skip appropriately
</success_criteria>

<output>
After completion, create `.planning/phases/01-test-infrastructure/01-01-SUMMARY.md`
</output>
