---
phase: 02-smoke-tests
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/megaraptor_mcp/server.py
  - src/megaraptor_mcp/tools/clients.py
  - src/megaraptor_mcp/tools/artifacts.py
  - src/megaraptor_mcp/tools/hunts.py
  - src/megaraptor_mcp/tools/flows.py
  - src/megaraptor_mcp/tools/vql.py
  - src/megaraptor_mcp/tools/deployment.py
  - src/megaraptor_mcp/resources/resources.py
  - src/megaraptor_mcp/prompts/prompts.py
  - tests/integration/helpers/mcp_helpers.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "MCP server starts without AttributeError"
    - "All 35 tools are registered and callable via FastMCP"
    - "Resources and prompts are registered"
  artifacts:
    - path: "src/megaraptor_mcp/server.py"
      provides: "FastMCP-based server factory"
      contains: "FastMCP"
    - path: "tests/integration/helpers/mcp_helpers.py"
      provides: "Working invoke_mcp_tool() helper"
      contains: "call_tool"
  key_links:
    - from: "src/megaraptor_mcp/server.py"
      to: "FastMCP"
      via: "import from mcp.server.fastmcp"
      pattern: "from mcp\\.server\\.fastmcp import FastMCP"
    - from: "tools/*.py"
      to: "mcp.tool()"
      via: "decorator on FastMCP instance"
      pattern: "@mcp\\.tool\\(\\)"
---

<objective>
Migrate MCP server from deprecated Server class to FastMCP for SDK 1.25.0 compatibility.

Purpose: The MCP SDK 1.25.0 removed the `@server.tool()` decorator from the `Server` class. All tool registration must use `FastMCP` which has the proper `@mcp.tool()` decorator. This blocks all 35 MCP tool tests (SMOKE-01).

Output: Working MCP server with all tools, resources, and prompts registered using FastMCP pattern.
</objective>

<execution_context>
@C:\Users\Meow\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Meow\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-smoke-tests/02-VERIFICATION.md
@src/megaraptor_mcp/server.py
@src/megaraptor_mcp/tools/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate server.py to FastMCP</name>
  <files>src/megaraptor_mcp/server.py</files>
  <action>
Replace Server with FastMCP throughout server.py:

1. Change import from `from mcp.server import Server` to `from mcp.server.fastmcp import FastMCP`
2. Change `Server("megaraptor-mcp")` to `FastMCP("megaraptor-mcp")`
3. Update registration calls - FastMCP uses a different pattern:
   - Instead of `register_X_tools(server)` which used `@server.tool()` internally
   - Export the FastMCP instance as a module-level `mcp` variable
   - Tool modules will use `@mcp.tool()` decorator directly on the shared instance

4. Refactor server.py to:
   - Create `mcp = FastMCP("megaraptor-mcp")` at module level
   - Remove the registration function calls (tools now register via decorator on import)
   - Update `run_server()` to use `mcp.run_stdio_async()`
   - Remove `create_server()` function (no longer needed with module-level mcp)

5. Keep the `main()` entry point working for CLI usage

The key architectural change: FastMCP uses module-level decorators, not runtime registration.
  </action>
  <verify>
```bash
python -c "from megaraptor_mcp.server import mcp; print('Server created:', mcp.name)"
```
Should print: "Server created: megaraptor-mcp"
  </verify>
  <done>server.py imports FastMCP, creates module-level mcp instance, no AttributeError on import</done>
</task>

<task type="auto">
  <name>Task 2: Migrate all tool modules to FastMCP decorators</name>
  <files>
src/megaraptor_mcp/tools/__init__.py
src/megaraptor_mcp/tools/clients.py
src/megaraptor_mcp/tools/artifacts.py
src/megaraptor_mcp/tools/hunts.py
src/megaraptor_mcp/tools/flows.py
src/megaraptor_mcp/tools/vql.py
src/megaraptor_mcp/tools/deployment.py
  </files>
  <action>
Migrate each tool module from `@server.tool()` to `@mcp.tool()` pattern:

**For each tool file (clients.py, artifacts.py, hunts.py, flows.py, vql.py, deployment.py):**

1. Replace the `register_X_tools(server: Server)` wrapper function pattern
2. Import the shared mcp instance: `from ..server import mcp`
3. Change `@server.tool()` decorators to `@mcp.tool()`
4. Remove the wrapper function - tools register automatically via decorator on import

**Example transformation for clients.py:**

BEFORE:
```python
from mcp.server import Server

def register_client_tools(server: Server) -> None:
    @server.tool()
    async def list_clients(...):
        ...
```

AFTER:
```python
from ..server import mcp

@mcp.tool()
async def list_clients(...):
    ...
```

5. Update `tools/__init__.py`:
   - Remove the register_X_tools imports (no longer needed)
   - Import the tool modules to trigger registration: `from . import clients, artifacts, hunts, flows, vql, deployment`
   - Keep __all__ for documentation but it's not strictly needed

IMPORTANT: The tool function signatures, docstrings, and implementations remain UNCHANGED. Only the registration pattern changes.
  </action>
  <verify>
```bash
python -c "
from megaraptor_mcp import tools
from megaraptor_mcp.server import mcp
import asyncio

# Check tools are registered
tools_list = asyncio.run(mcp.list_tools())
print(f'Tools registered: {len(tools_list)}')
tool_names = [t.name for t in tools_list]
print(f'Sample tools: {tool_names[:5]}')
assert len(tools_list) >= 35, f'Expected 35+ tools, got {len(tools_list)}'
print('All tools registered successfully')
"
```
Should show 35+ tools registered.
  </verify>
  <done>All 35 tools register via @mcp.tool() decorator, no Server.tool() usage remains</done>
</task>

<task type="auto">
  <name>Task 3: Migrate resources and prompts, update test helpers</name>
  <files>
src/megaraptor_mcp/resources/resources.py
src/megaraptor_mcp/prompts/prompts.py
tests/integration/helpers/mcp_helpers.py
  </files>
  <action>
**Migrate resources.py:**

1. Import shared mcp: `from ..server import mcp`
2. Replace `@server.list_resources()` with `@mcp.resource("uri")` pattern
   - FastMCP uses `@mcp.resource("velociraptor://clients")` decorator on resource functions
3. Replace `@server.read_resource()` with individual resource handlers
4. Remove the `register_resources(server)` wrapper function

**Migrate prompts.py:**

1. Import shared mcp: `from ..server import mcp`
2. Replace `@server.list_prompts()` with `@mcp.prompt()` decorator
3. Replace `@server.get_prompt()` if used
4. Remove the `register_prompts(server)` wrapper function

**Update mcp_helpers.py:**

The test helper needs to work with FastMCP's call_tool:

```python
from megaraptor_mcp.server import mcp

async def invoke_mcp_tool(tool_name: str, arguments: dict) -> tuple[bool, Any]:
    try:
        result = await mcp.call_tool(tool_name, arguments)
        # ... rest of parsing logic stays the same
```

Key change: Import the module-level `mcp` instance instead of calling `create_server()`.

IMPORTANT: The resource URIs, prompt definitions, and helper parsing logic remain UNCHANGED. Only the registration and invocation pattern changes.
  </action>
  <verify>
```bash
cd C:/Users/Meow/Documents/Projects/megaraptor-mcp && python -c "
from megaraptor_mcp.server import mcp
from megaraptor_mcp import resources, prompts
import asyncio

# Check resources
res_list = asyncio.run(mcp.list_resources())
print(f'Resources: {len(res_list)}')

# Check prompts
prompt_list = asyncio.run(mcp.list_prompts())
print(f'Prompts: {len(prompt_list)}')

# Test invoke helper
from tests.integration.helpers.mcp_helpers import invoke_mcp_tool
success, data = asyncio.run(invoke_mcp_tool('vql_help', {}))
print(f'invoke_mcp_tool works: {success}')
"
```
  </verify>
  <done>Resources and prompts register via FastMCP decorators, invoke_mcp_tool() uses shared mcp instance</done>
</task>

</tasks>

<verification>
Run the MCP tool smoke tests that were previously failing:

```bash
cd C:/Users/Meow/Documents/Projects/megaraptor-mcp
pytest tests/integration/test_smoke_mcp_tools.py -v --tb=short -x 2>&1 | head -50
```

Verify no AttributeError on Server.tool(). Tools should now invoke (may still fail for other reasons like missing client_id, but that's expected).
</verification>

<success_criteria>
1. `from megaraptor_mcp.server import mcp` works without errors
2. All 35 tools are registered (verified by mcp.list_tools())
3. Resources are accessible via mcp.list_resources()
4. Prompts are accessible via mcp.list_prompts()
5. invoke_mcp_tool() can call tools without AttributeError
6. Existing VQL tests still pass (regression check)
</success_criteria>

<output>
After completion, create `.planning/phases/02-smoke-tests/02-05-SUMMARY.md`
</output>
