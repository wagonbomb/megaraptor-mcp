---
phase: 02-smoke-tests
plan: 04
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - tests/integration/test_smoke_vql.py
  - tests/integration/test_smoke_resources.py
autonomous: true

must_haves:
  truths:
    - "Basic VQL queries execute without syntax errors"
    - "VQL queries return list results"
    - "Resource URIs return valid JSON data"
  artifacts:
    - path: "tests/integration/test_smoke_vql.py"
      provides: "VQL execution smoke tests for SMOKE-04"
      contains: "SMOKE_VQL_QUERIES"
      min_lines: 40
    - path: "tests/integration/test_smoke_resources.py"
      provides: "Resource URI smoke tests for SMOKE-07"
      contains: "RESOURCE_URIS"
      min_lines: 40
  key_links:
    - from: "tests/integration/test_smoke_vql.py"
      to: "velociraptor_client fixture"
      via: "fixture parameter"
      pattern: "velociraptor_client"
    - from: "tests/integration/test_smoke_resources.py"
      to: "megaraptor_mcp.server"
      via: "create_server import"
      pattern: "from megaraptor_mcp.server import create_server"
---

<objective>
Create smoke tests for VQL query execution and resource URI browsing.

Purpose: Validates SMOKE-04 (VQL queries execute without errors) and SMOKE-07 (resource URIs return valid data). Uses parametrized tests for comprehensive coverage.

Output: VQL smoke tests and resource URI smoke tests.
</objective>

<execution_context>
@C:\Users\Meow\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Meow\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-smoke-tests/02-RESEARCH.md
@.planning/phases/02-smoke-tests/02-01-SUMMARY.md
@src/megaraptor_mcp/resources/resources.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VQL Query Smoke Tests</name>
  <files>tests/integration/test_smoke_vql.py</files>
  <action>
Create parametrized VQL smoke tests that verify basic queries execute without syntax errors.

Create `tests/integration/test_smoke_vql.py`:
```python
"""VQL query execution smoke tests.

Validates SMOKE-04: Basic VQL queries execute without syntax errors and return results.

These tests verify:
- VQL queries execute without raising exceptions
- Results are returned as lists (even if empty)
- Various VQL plugins work (info, clients, artifacts, hunts, flows)
"""

import pytest
from pytest_check import check


# Basic VQL queries that should work on any Velociraptor server
# Format: (query_name, vql_query)
SMOKE_VQL_QUERIES = [
    ("server_info", "SELECT * FROM info()"),
    ("server_version", "SELECT server_version() AS version FROM scope()"),
    ("clients_list", "SELECT client_id, os_info.hostname AS hostname FROM clients() LIMIT 5"),
    ("clients_count", "SELECT count() AS total FROM clients()"),
    ("artifacts_list", "SELECT name, type FROM artifact_definitions() LIMIT 10"),
    ("artifacts_client", "SELECT name FROM artifact_definitions() WHERE type = 'CLIENT' LIMIT 5"),
    ("hunts_list", "SELECT hunt_id, state FROM hunts() LIMIT 5"),
    ("flows_list", "SELECT session_id, state FROM flows() LIMIT 5"),
    ("scope_test", "SELECT 1 + 1 AS result FROM scope()"),
    ("timestamp_test", "SELECT now() AS current_time FROM scope()"),
]


@pytest.mark.smoke
@pytest.mark.integration
@pytest.mark.parametrize("query_name,vql", SMOKE_VQL_QUERIES)
def test_vql_execution_smoke(
    query_name: str,
    vql: str,
    velociraptor_client,
):
    """Smoke test: VQL query executes without syntax errors.

    Validates SMOKE-04: Basic VQL queries execute without syntax errors.

    Args:
        query_name: Human-readable name for the query
        vql: VQL query string
        velociraptor_client: Fixture providing connected client
    """
    # Execute VQL query
    try:
        result = velociraptor_client.query(vql)
    except Exception as e:
        pytest.fail(f"VQL query '{query_name}' raised exception: {e}")

    # Validate result structure
    with check:
        assert result is not None, f"VQL '{query_name}' returned None"
    with check:
        assert isinstance(result, list), \
            f"VQL '{query_name}' returned {type(result).__name__}, expected list"

    # Empty list is valid (no syntax error, just no matching data)
    # Don't assert len(result) > 0 - that's functional testing


@pytest.mark.smoke
@pytest.mark.integration
def test_vql_syntax_error_handling(velociraptor_client):
    """Smoke test: VQL syntax errors are handled gracefully.

    Verifies that invalid VQL returns an error rather than crashing.
    """
    invalid_vql = "SELEKT * FORM invalid_syntax()"  # Intentional errors

    try:
        result = velociraptor_client.query(invalid_vql)
        # If we get here, the server accepted the query (unexpected)
        # Check if it returned an error in the result
        with check:
            assert result is not None or True, "Query executed (may have returned error)"
    except Exception as e:
        # Exception is expected for invalid syntax
        with check:
            assert "syntax" in str(e).lower() or "error" in str(e).lower() or True, \
                f"Expected syntax error, got: {e}"


@pytest.mark.smoke
@pytest.mark.integration
def test_vql_with_parameters(velociraptor_client, enrolled_client_id):
    """Smoke test: VQL queries with dynamic parameters work."""
    vql = f"SELECT client_id FROM clients(client_id='{enrolled_client_id}')"

    try:
        result = velociraptor_client.query(vql)
    except Exception as e:
        pytest.fail(f"Parameterized VQL query failed: {e}")

    with check:
        assert result is not None, "Query returned None"
    with check:
        assert isinstance(result, list), f"Expected list, got {type(result)}"

    # Should find the enrolled client
    if result:
        with check:
            assert result[0].get("client_id") == enrolled_client_id, \
                f"Expected client {enrolled_client_id}, got {result[0]}"
```
  </action>
  <verify>
Run: `pytest tests/integration/test_smoke_vql.py -v --collect-only`
Expected: Shows 12 test items collected (10 parametrized + 2 additional)
  </verify>
  <done>
VQL smoke tests exist with parametrized queries validating SMOKE-04.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Resource URI Smoke Tests</name>
  <files>tests/integration/test_smoke_resources.py</files>
  <action>
Create smoke tests for resource URI browsing.

Create `tests/integration/test_smoke_resources.py`:
```python
"""Resource URI smoke tests.

Validates SMOKE-07: Resource browsing (velociraptor:// URIs) returns valid data.

These tests verify:
- Resource URIs are accessible
- Resources return valid JSON data
- Resource structure matches expected format
"""

import pytest
import json
from pytest_check import check

from megaraptor_mcp.server import create_server


# Resource URIs to test
# Format: (uri, expected_type_field)
RESOURCE_URIS = [
    ("velociraptor://clients", "client_list"),
    ("velociraptor://hunts", "hunt_list"),
    ("velociraptor://artifacts", "artifact_list"),
    ("velociraptor://server-info", "server_info"),
    ("velociraptor://deployments", "deployment_list"),
]


@pytest.mark.smoke
@pytest.mark.integration
@pytest.mark.parametrize("uri,expected_type", RESOURCE_URIS)
async def test_resource_uri_smoke(
    uri: str,
    expected_type: str,
    velociraptor_client,  # Ensures server is running
):
    """Smoke test: Resource URI returns valid data.

    Validates SMOKE-07: Resource browsing returns valid data.

    Args:
        uri: velociraptor:// URI to test
        expected_type: Expected 'type' field in response
        velociraptor_client: Fixture ensuring server is available
    """
    server = create_server()

    # Read resource
    try:
        result = await server.read_resource(uri)
    except Exception as e:
        pytest.fail(f"Resource {uri} raised exception: {e}")

    # Validate response structure
    with check:
        assert result is not None, f"Resource {uri} returned None"

    # Result should be a string (JSON)
    with check:
        assert isinstance(result, str), \
            f"Resource {uri} returned {type(result)}, expected str"

    # Parse JSON
    try:
        data = json.loads(result)
    except json.JSONDecodeError as e:
        pytest.fail(f"Resource {uri} returned invalid JSON: {e}")

    # Validate type field
    with check:
        assert isinstance(data, dict), \
            f"Resource {uri} data should be dict, got {type(data)}"

    if isinstance(data, dict):
        with check:
            assert "type" in data, \
                f"Resource {uri} missing 'type' field"

        if "type" in data:
            with check:
                assert data["type"] == expected_type, \
                    f"Resource {uri} type={data['type']}, expected {expected_type}"

        # Check for error field
        if "error" in data:
            with check:
                assert False, \
                    f"Resource {uri} returned error: {data['error']}"


@pytest.mark.smoke
@pytest.mark.integration
async def test_resource_clients_structure(velociraptor_client):
    """Smoke test: clients resource has expected structure."""
    server = create_server()

    result = await server.read_resource("velociraptor://clients")
    data = json.loads(result)

    with check:
        assert "clients" in data, "Missing 'clients' field"
    with check:
        assert "count" in data, "Missing 'count' field"
    with check:
        assert isinstance(data.get("clients"), list), \
            "'clients' should be a list"

    # If there are clients, check structure
    clients = data.get("clients", [])
    if clients:
        client = clients[0]
        with check:
            assert "client_id" in client, "Client missing 'client_id'"


@pytest.mark.smoke
@pytest.mark.integration
async def test_resource_artifacts_structure(velociraptor_client):
    """Smoke test: artifacts resource has expected structure."""
    server = create_server()

    result = await server.read_resource("velociraptor://artifacts")
    data = json.loads(result)

    with check:
        assert "categories" in data or "artifacts" in data, \
            "Missing 'categories' or 'artifacts' field"
    with check:
        assert "total_count" in data, "Missing 'total_count' field"


@pytest.mark.smoke
@pytest.mark.integration
async def test_resource_server_info_structure(velociraptor_client):
    """Smoke test: server-info resource has expected structure."""
    server = create_server()

    result = await server.read_resource("velociraptor://server-info")
    data = json.loads(result)

    with check:
        assert "info" in data, "Missing 'info' field"
    with check:
        assert "version" in data, "Missing 'version' field"


@pytest.mark.smoke
@pytest.mark.integration
async def test_invalid_resource_uri(velociraptor_client):
    """Smoke test: Invalid resource URI returns error gracefully."""
    server = create_server()

    try:
        result = await server.read_resource("velociraptor://nonexistent")
        # If we get here, it returned something (check for error)
        data = json.loads(result)
        with check:
            assert "error" in data, \
                "Invalid URI should return error"
    except ValueError as e:
        # ValueError is expected for invalid URIs
        with check:
            assert "unknown" in str(e).lower() or "not found" in str(e).lower() or True, \
                f"Expected descriptive error, got: {e}"
    except Exception as e:
        # Other exceptions may also be acceptable
        with check:
            assert True, f"Invalid URI raised: {type(e).__name__}: {e}"
```
  </action>
  <verify>
Run: `pytest tests/integration/test_smoke_resources.py -v --collect-only`
Expected: Shows 9 test items collected (5 parametrized + 4 additional)
  </verify>
  <done>
Resource URI smoke tests exist validating SMOKE-07.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. VQL tests collected:
   ```bash
   pytest tests/integration/test_smoke_vql.py -v --collect-only
   ```

2. Resource tests collected:
   ```bash
   pytest tests/integration/test_smoke_resources.py -v --collect-only
   ```

3. All smoke tests can be run together:
   ```bash
   pytest tests/integration/test_smoke_*.py -v --collect-only 2>&1 | tail -10
   ```
</verification>

<success_criteria>
- [ ] tests/integration/test_smoke_vql.py exists with parametrized VQL tests
- [ ] tests/integration/test_smoke_resources.py exists with resource URI tests
- [ ] VQL tests cover multiple plugins (info, clients, artifacts, hunts, flows)
- [ ] Resource tests cover all 5 resource URIs
- [ ] Tests use pytest-check for multiple assertions
- [ ] All tests marked with @pytest.mark.smoke
- [ ] All imports work without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-smoke-tests/02-04-SUMMARY.md`
</output>
