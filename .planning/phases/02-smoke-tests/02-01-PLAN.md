---
phase: 02-smoke-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/integration/schemas/__init__.py
  - tests/integration/schemas/base_schemas.py
  - tests/integration/helpers/mcp_helpers.py
  - tests/integration/test_smoke_connectivity.py
autonomous: true

must_haves:
  truths:
    - "Schema registry provides JSON schemas for MCP tool validation"
    - "MCP helper can invoke tools and return parsed responses"
    - "Server connectivity test verifies gRPC connection before other tests"
  artifacts:
    - path: "tests/integration/schemas/__init__.py"
      provides: "Schema registry with get_tool_schema function"
      exports: ["get_tool_schema"]
    - path: "tests/integration/schemas/base_schemas.py"
      provides: "Minimal JSON schemas for critical tool outputs"
      contains: "LIST_CLIENTS_SCHEMA"
    - path: "tests/integration/helpers/mcp_helpers.py"
      provides: "MCP tool invocation helper for smoke tests"
      exports: ["invoke_mcp_tool", "parse_tool_response"]
    - path: "tests/integration/test_smoke_connectivity.py"
      provides: "Server connectivity verification smoke test"
      contains: "test_server_connectivity"
  key_links:
    - from: "tests/integration/schemas/__init__.py"
      to: "tests/integration/schemas/base_schemas.py"
      via: "import statement"
      pattern: "from .base_schemas import"
    - from: "tests/integration/helpers/mcp_helpers.py"
      to: "megaraptor_mcp.server"
      via: "create_server import"
      pattern: "from megaraptor_mcp.server import create_server"
---

<objective>
Create the foundational infrastructure for Phase 2 smoke testing: JSON schema registry for output validation, MCP tool invocation helpers, and server connectivity verification.

Purpose: Establishes shared test infrastructure that all subsequent smoke test plans depend on. The schema registry enables SMOKE-05 (JSON Schema validation), the MCP helper enables clean tool invocation in parametrized tests, and the connectivity test (SMOKE-06) gates all other tests.

Output: Schema registry module, MCP helper module, and passing connectivity smoke test.
</objective>

<execution_context>
@C:\Users\Meow\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Meow\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-smoke-tests/02-RESEARCH.md
@tests/conftest.py
@src/megaraptor_mcp/server.py
@tests/integration/helpers/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create JSON Schema Registry</name>
  <files>
    tests/integration/schemas/__init__.py
    tests/integration/schemas/base_schemas.py
  </files>
  <action>
Create a JSON schema registry for MCP tool output validation. Following the research guidance, keep schemas minimal - only validate critical fields that AI assistants need to parse.

Create `tests/integration/schemas/base_schemas.py` with minimal schemas:
```python
"""Base JSON schemas for MCP tool output validation.

Schemas validate only critical fields - keep minimal to avoid brittleness.
Do NOT use additionalProperties: false - allow new fields.
"""

# Client tool schemas
LIST_CLIENTS_SCHEMA = {
    "type": "array",
    "items": {
        "type": "object",
        "required": ["client_id"],
        "properties": {
            "client_id": {"type": "string", "pattern": "^C\\."},
            "hostname": {"type": "string"},
        }
    }
}

GET_CLIENT_INFO_SCHEMA = {
    "type": "object",
    "required": ["client_id"],
    "properties": {
        "client_id": {"type": "string", "pattern": "^C\\."},
    }
}

# Artifact tool schemas
LIST_ARTIFACTS_SCHEMA = {
    "type": "array",
    "items": {
        "type": "object",
        "required": ["name"],
        "properties": {
            "name": {"type": "string"},
            "type": {"type": "string"},
        }
    }
}

COLLECT_ARTIFACT_SCHEMA = {
    "type": "object",
    "required": ["flow_id"],
    "properties": {
        "flow_id": {"type": "string"},
        "status": {"type": "string"},
    }
}

# VQL tool schemas
RUN_VQL_SCHEMA = {
    "type": "object",
    "required": ["results"],
    "properties": {
        "query": {"type": "string"},
        "row_count": {"type": "integer"},
        "results": {"type": "array"},
    }
}

# Hunt tool schemas
LIST_HUNTS_SCHEMA = {
    "type": "array",
    "items": {
        "type": "object",
        "properties": {
            "hunt_id": {"type": "string"},
            "state": {"type": "string"},
        }
    }
}

CREATE_HUNT_SCHEMA = {
    "type": "object",
    "required": ["hunt_id"],
    "properties": {
        "hunt_id": {"type": "string"},
        "status": {"type": "string"},
    }
}

# Flow tool schemas
LIST_FLOWS_SCHEMA = {
    "type": "array",
    "items": {
        "type": "object",
        "properties": {
            "flow_id": {"type": "string"},
            "state": {"type": "string"},
        }
    }
}

GET_FLOW_STATUS_SCHEMA = {
    "type": "object",
    "properties": {
        "flow_id": {"type": "string"},
        "state": {"type": "string"},
        "client_id": {"type": "string"},
    }
}

# Deployment tool schemas (minimal - many return similar structure)
DEPLOYMENT_STATUS_SCHEMA = {
    "type": "object",
    "properties": {
        "deployment_id": {"type": "string"},
        "state": {"type": "string"},
    }
}

LIST_DEPLOYMENTS_SCHEMA = {
    "type": "object",
    "required": ["deployments"],
    "properties": {
        "count": {"type": "integer"},
        "deployments": {"type": "array"},
    }
}
```

Create `tests/integration/schemas/__init__.py`:
```python
"""JSON Schema registry for MCP tool output validation."""

from typing import Optional
from .base_schemas import (
    LIST_CLIENTS_SCHEMA,
    GET_CLIENT_INFO_SCHEMA,
    LIST_ARTIFACTS_SCHEMA,
    COLLECT_ARTIFACT_SCHEMA,
    RUN_VQL_SCHEMA,
    LIST_HUNTS_SCHEMA,
    CREATE_HUNT_SCHEMA,
    LIST_FLOWS_SCHEMA,
    GET_FLOW_STATUS_SCHEMA,
    DEPLOYMENT_STATUS_SCHEMA,
    LIST_DEPLOYMENTS_SCHEMA,
)

_SCHEMA_REGISTRY = {
    # Client tools
    "list_clients": LIST_CLIENTS_SCHEMA,
    "get_client_info": GET_CLIENT_INFO_SCHEMA,
    # label_client and quarantine_client have variable output, skip schema

    # Artifact tools
    "list_artifacts": LIST_ARTIFACTS_SCHEMA,
    # get_artifact returns full artifact definition, too variable for schema
    "collect_artifact": COLLECT_ARTIFACT_SCHEMA,

    # VQL tools
    "run_vql": RUN_VQL_SCHEMA,
    # vql_help returns text, not JSON

    # Hunt tools
    "list_hunts": LIST_HUNTS_SCHEMA,
    "create_hunt": CREATE_HUNT_SCHEMA,
    # get_hunt_results, modify_hunt have variable output

    # Flow tools
    "list_flows": LIST_FLOWS_SCHEMA,
    "get_flow_status": GET_FLOW_STATUS_SCHEMA,
    # get_flow_results, cancel_flow have variable output

    # Deployment tools
    "get_deployment_status": DEPLOYMENT_STATUS_SCHEMA,
    "list_deployments": LIST_DEPLOYMENTS_SCHEMA,
    # Most deployment tools have variable output
}


def get_tool_schema(tool_name: str) -> Optional[dict]:
    """Get JSON schema for a tool's output.

    Returns None if no schema defined (validation skipped).
    """
    return _SCHEMA_REGISTRY.get(tool_name)
```
  </action>
  <verify>
Run: `python -c "from tests.integration.schemas import get_tool_schema; print(get_tool_schema('list_clients'))"`
Expected: Prints the LIST_CLIENTS_SCHEMA dict
  </verify>
  <done>
Schema registry module exists with get_tool_schema function that returns schemas for key tools.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create MCP Tool Invocation Helper</name>
  <files>
    tests/integration/helpers/mcp_helpers.py
    tests/integration/helpers/__init__.py
  </files>
  <action>
Create an MCP tool invocation helper that wraps server.call_tool() for clean test usage. This helper handles:
- Creating the server instance
- Invoking tools with proper async handling
- Parsing JSON responses
- Handling errors gracefully

Create `tests/integration/helpers/mcp_helpers.py`:
```python
"""MCP tool invocation helpers for smoke tests.

Provides clean interface for invoking MCP tools in tests.
"""

import json
from typing import Any, Optional

from megaraptor_mcp.server import create_server


async def invoke_mcp_tool(
    tool_name: str,
    arguments: dict[str, Any],
) -> tuple[bool, Any]:
    """Invoke an MCP tool and return parsed response.

    Args:
        tool_name: Name of the MCP tool to invoke
        arguments: Dictionary of arguments to pass to the tool

    Returns:
        Tuple of (success: bool, response: Any)
        - success=True, response=parsed JSON data
        - success=False, response=error message string
    """
    server = create_server()

    try:
        result = await server.call_tool(tool_name, arguments)

        if not result:
            return False, "Tool returned empty result"

        # First content item should be TextContent
        content = result[0]

        if not hasattr(content, 'text'):
            return False, f"Response missing 'text' attribute: {type(content)}"

        # Parse JSON response
        try:
            data = json.loads(content.text)

            # Check for error field in response
            if isinstance(data, dict) and "error" in data and data["error"]:
                return False, data["error"]

            return True, data

        except json.JSONDecodeError as e:
            # Some tools return plain text (like vql_help)
            return True, content.text

    except Exception as e:
        return False, str(e)


def parse_tool_response(result: list) -> tuple[bool, Any]:
    """Parse an MCP tool result into usable data.

    Args:
        result: Raw result from server.call_tool()

    Returns:
        Tuple of (success: bool, data: Any)
    """
    if not result:
        return False, "Empty result"

    content = result[0]

    if not hasattr(content, 'text'):
        return False, f"Missing 'text' attribute: {type(content)}"

    try:
        data = json.loads(content.text)

        if isinstance(data, dict) and "error" in data and data["error"]:
            return False, data["error"]

        return True, data

    except json.JSONDecodeError:
        # Plain text response
        return True, content.text


def replace_placeholders(arguments: dict, client_id: Optional[str] = None) -> dict:
    """Replace placeholder values in tool arguments.

    Args:
        arguments: Tool arguments dict
        client_id: Real client ID to substitute

    Returns:
        Arguments with placeholders replaced
    """
    result = arguments.copy()

    if client_id:
        for key in ["client_id"]:
            if key in result and result[key] in ("C.placeholder", "C.test"):
                result[key] = client_id

    return result
```

Update `tests/integration/helpers/__init__.py` to export the new helpers:
```python
"""Test helpers for integration tests."""

from .wait_helpers import (
    wait_for_flow_completion,
    wait_for_client_enrollment,
    wait_for_hunt_completion,
)
from .cleanup_helpers import (
    cleanup_test_hunts,
    cleanup_test_labels,
    cleanup_test_flows,
)
from .target_registry import TargetRegistry, TestTarget
from .cert_monitor import check_cert_expiration
from .mcp_helpers import invoke_mcp_tool, parse_tool_response, replace_placeholders

__all__ = [
    # Wait helpers
    "wait_for_flow_completion",
    "wait_for_client_enrollment",
    "wait_for_hunt_completion",
    # Cleanup helpers
    "cleanup_test_hunts",
    "cleanup_test_labels",
    "cleanup_test_flows",
    # Target registry
    "TargetRegistry",
    "TestTarget",
    # Certificate monitoring
    "check_cert_expiration",
    # MCP helpers
    "invoke_mcp_tool",
    "parse_tool_response",
    "replace_placeholders",
]
```
  </action>
  <verify>
Run: `python -c "from tests.integration.helpers import invoke_mcp_tool; print('MCP helpers imported successfully')"`
Expected: Prints success message without import errors
  </verify>
  <done>
MCP helper module exists with invoke_mcp_tool, parse_tool_response, and replace_placeholders functions exported from helpers package.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Server Connectivity Smoke Test</name>
  <files>tests/integration/test_smoke_connectivity.py</files>
  <action>
Create a server connectivity smoke test that verifies:
1. VelociraptorClient can connect to the server
2. Basic VQL query executes (SELECT * FROM info())
3. At least one client is enrolled

This test gates all other smoke tests (SMOKE-06 requirement).

Create `tests/integration/test_smoke_connectivity.py`:
```python
"""Server connectivity smoke tests.

Validates SMOKE-06: Server connectivity and authentication verified before test runs.

These tests verify basic infrastructure before running other smoke tests.
"""

import pytest
from pytest_check import check


@pytest.mark.smoke
@pytest.mark.integration
class TestServerConnectivity:
    """Test server connectivity and basic operations."""

    def test_server_connection(self, velociraptor_client):
        """Smoke test: Verify server is accessible and responds to VQL.

        This is the foundational smoke test - if this fails, all other
        smoke tests will fail.
        """
        # Execute simplest VQL query
        vql = "SELECT * FROM info()"

        try:
            result = velociraptor_client.query(vql)
        except Exception as e:
            pytest.fail(f"Server connection failed: {e}")

        # Validate result structure
        with check:
            assert result is not None, "info() returned None"
        with check:
            assert isinstance(result, list), f"Expected list, got {type(result)}"
        with check:
            assert len(result) > 0, "info() returned empty result"

        # Validate server info fields
        if result:
            info = result[0]
            with check:
                assert "version" in info or "Version" in info, \
                    "Server info missing version field"

    def test_client_enrolled(self, velociraptor_client, enrolled_client_id):
        """Smoke test: Verify at least one client is enrolled.

        Tests require enrolled clients for artifact collection and flow testing.
        """
        with check:
            assert enrolled_client_id is not None, "No enrolled client ID"
        with check:
            assert enrolled_client_id.startswith("C."), \
                f"Invalid client ID format: {enrolled_client_id}"

        # Verify client exists in server
        vql = f"SELECT client_id FROM clients(client_id='{enrolled_client_id}')"
        result = velociraptor_client.query(vql)

        with check:
            assert len(result) > 0, f"Client {enrolled_client_id} not found on server"

    def test_vql_execution(self, velociraptor_client):
        """Smoke test: Verify VQL execution works with various query types."""
        test_queries = [
            ("info", "SELECT * FROM info()"),
            ("clients_list", "SELECT client_id FROM clients() LIMIT 5"),
            ("artifacts", "SELECT name FROM artifact_definitions() LIMIT 5"),
        ]

        for query_name, vql in test_queries:
            try:
                result = velociraptor_client.query(vql)
                with check:
                    assert result is not None, f"Query '{query_name}' returned None"
                with check:
                    assert isinstance(result, list), \
                        f"Query '{query_name}' returned {type(result)}, expected list"
            except Exception as e:
                pytest.fail(f"Query '{query_name}' failed: {e}")
```
  </action>
  <verify>
Run: `pytest tests/integration/test_smoke_connectivity.py -v --tb=short -m smoke 2>&1 | head -50`
Expected: Tests pass (or skip if Docker not running). No import errors.
  </verify>
  <done>
Server connectivity smoke test exists and validates SMOKE-06 requirement. Tests verify server connection, client enrollment, and VQL execution.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Schema registry imports work:
   ```bash
   python -c "from tests.integration.schemas import get_tool_schema; print(get_tool_schema('list_clients'))"
   ```

2. MCP helpers import work:
   ```bash
   python -c "from tests.integration.helpers import invoke_mcp_tool, replace_placeholders; print('OK')"
   ```

3. Connectivity tests run (may skip if Docker not running):
   ```bash
   pytest tests/integration/test_smoke_connectivity.py -v --tb=short 2>&1 | head -30
   ```
</verification>

<success_criteria>
- [ ] tests/integration/schemas/__init__.py exists with get_tool_schema function
- [ ] tests/integration/schemas/base_schemas.py exists with minimal schemas
- [ ] tests/integration/helpers/mcp_helpers.py exists with invoke_mcp_tool
- [ ] tests/integration/helpers/__init__.py exports MCP helpers
- [ ] tests/integration/test_smoke_connectivity.py exists with smoke tests
- [ ] All imports work without errors
- [ ] pytest marker 'smoke' is used on connectivity tests
</success_criteria>

<output>
After completion, create `.planning/phases/02-smoke-tests/02-01-SUMMARY.md`
</output>
