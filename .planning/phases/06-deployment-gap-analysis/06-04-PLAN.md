---
phase: 06-deployment-gap-analysis
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/GAP_ANALYSIS.md
autonomous: true

must_haves:
  truths:
    - "Gap analysis document identifies missing tool capabilities systematically"
    - "Deployment improvement recommendations are documented with rationale"
    - "Cloud testing requirements are scoped for next milestone"
  artifacts:
    - path: "docs/GAP_ANALYSIS.md"
      provides: "Comprehensive gap analysis and recommendations"
      contains: ["## Tool Capability Gaps", "## Deployment Recommendations", "## Cloud Testing Scope"]
  key_links:
    - from: "docs/GAP_ANALYSIS.md"
      to: ".planning/phases/06-deployment-gap-analysis/06-RESEARCH.md"
      via: "References research for tool inventory"
      pattern: "35 MCP tools"
---

<objective>
Create comprehensive gap analysis document covering tool capabilities, deployment improvements, and cloud testing scope.

Purpose: GAP-01, GAP-02, and GAP-03 require documentation of missing capabilities and future requirements. This is a documentation exercise that informs the next milestone.

Output: docs/GAP_ANALYSIS.md with systematic analysis of tool gaps, deployment recommendations, and cloud testing scope.
</objective>

<execution_context>
@C:\Users\Meow\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Meow\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/06-deployment-gap-analysis/06-RESEARCH.md
@src/megaraptor_mcp/tools/deployment.py
@src/megaraptor_mcp/tools/clients.py
@src/megaraptor_mcp/tools/artifacts.py
@src/megaraptor_mcp/tools/hunts.py
@src/megaraptor_mcp/tools/flows.py
@src/megaraptor_mcp/tools/vql.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Analyze tool capabilities against DFIR workflows</name>
  <files>docs/GAP_ANALYSIS.md</files>
  <action>
Create docs/GAP_ANALYSIS.md with systematic tool capability analysis (GAP-01):

1. Document header:
```markdown
# Megaraptor MCP Gap Analysis

**Version:** 1.0
**Date:** [current date]
**Scope:** v1.0 Quality & Real-World Validation Milestone

## Executive Summary

This document identifies capability gaps in the 35 MCP tools based on real-world DFIR workflow requirements. It provides recommendations for deployment improvements and scopes cloud testing requirements for the next milestone.
```

2. Section: Tool Capability Assessment

For each workflow category, analyze tool coverage:

**Triage Workflow:**
| Step | Capability | Current Tool | Gap Status |
|------|------------|--------------|------------|
| List processes | Running process enumeration | run_vql + pslist() | Covered |
| Network connections | Active network state | run_vql + netstat() | Covered |
| Quick client info | System identification | get_client_info | Covered |
| Memory state | Process memory analysis | collect_artifact | Partial - requires specific artifact |

**Collection Workflow:**
| Step | Capability | Current Tool | Gap Status |
|------|------------|--------------|------------|
| Schedule collection | Artifact scheduling | collect_artifact | Covered |
| Mass collection | Hunt creation | create_hunt | Covered |
| Offline collection | Air-gapped systems | create_offline_collector | Covered |
| Progress monitoring | Flow status | get_flow_status | Covered |

**Analysis Workflow:**
| Step | Capability | Current Tool | Gap Status |
|------|------------|--------------|------------|
| Ad-hoc queries | VQL execution | run_vql | Covered |
| Result retrieval | Flow/hunt results | get_flow_results, get_hunt_results | Covered |
| Timeline generation | Event timeline | N/A | GAP: No timeline tool |
| IOC extraction | Indicator extraction | N/A | GAP: No IOC tool |

**Remediation Workflow:**
| Step | Capability | Current Tool | Gap Status |
|------|------------|--------------|------------|
| Client isolation | Network quarantine | quarantine_client | Covered |
| Flow cancellation | Stop running flow | cancel_flow | Covered |
| Hunt control | Start/stop hunts | modify_hunt | Covered |
| File remediation | Delete/quarantine files | N/A | GAP: No remediation tool |

3. Identify Critical Gaps:
- Timeline generation tool (DFIR essential)
- IOC extraction tool (threat hunting essential)
- File remediation tool (response capability)
- Report generation tool (documentation essential)
  </action>
  <verify>
Check file exists and contains workflow tables:
grep -c "| Step | Capability |" docs/GAP_ANALYSIS.md
Should return: 4 (one table per workflow)
  </verify>
  <done>
GAP-01: Tool capability gaps documented with workflow-based assessment.
  </done>
</task>

<task type="auto">
  <name>Task 2: Document deployment improvement recommendations</name>
  <files>docs/GAP_ANALYSIS.md</files>
  <action>
Add deployment recommendations section to docs/GAP_ANALYSIS.md (GAP-02):

1. Section: Deployment Improvement Recommendations

```markdown
## Deployment Improvement Recommendations

Based on validation testing in Phase 6, the following improvements are recommended:

### Priority 1: Critical Improvements

#### 1.1 Health Check Timeout Configuration
**Issue:** Default health check timeout (120s) may be insufficient for slow networks
**Recommendation:** Make timeout configurable via environment variable
**Rationale:** Different deployment environments have different latency characteristics

#### 1.2 Certificate Validation Errors
**Issue:** Self-signed cert errors are not user-friendly
**Recommendation:** Add explicit "self-signed certificate" detection with guidance
**Rationale:** Most incident deployments use self-signed certs

#### 1.3 Deployment State Persistence
**Issue:** Deployment state lost on tool restart
**Recommendation:** Persist deployment registry to disk
**Rationale:** Users need to reconnect to existing deployments

### Priority 2: Enhancement Recommendations

#### 2.1 Deployment Profiles
**Issue:** Only three profiles (rapid, standard, enterprise)
**Recommendation:** Add "minimal" profile for resource-constrained environments
**Rationale:** Some IR scenarios require minimal footprint

#### 2.2 Container Image Versioning
**Issue:** Latest tag used by default
**Recommendation:** Pin to specific Velociraptor version
**Rationale:** Version consistency across deployments

#### 2.3 Network Isolation Options
**Issue:** No built-in network isolation for deployed servers
**Recommendation:** Add Docker network isolation options
**Rationale:** Security best practice for incident response

### Priority 3: Future Considerations

#### 3.1 Multi-Server Deployments
**Issue:** Single server deployment only
**Recommendation:** Add multi-frontend support
**Rationale:** Scale for large enterprises

#### 3.2 Kubernetes Deployment
**Issue:** Docker only, no K8s support
**Recommendation:** Add Helm chart or K8s manifests
**Rationale:** Enterprise environments use K8s
```

2. Add rationale for each recommendation based on testing observations.

3. Prioritize by impact and implementation effort.
  </action>
  <verify>
grep "Priority 1:" docs/GAP_ANALYSIS.md && grep "Priority 2:" docs/GAP_ANALYSIS.md
Should return both priority sections
  </verify>
  <done>
GAP-02: Deployment improvement recommendations documented with priorities.
  </done>
</task>

<task type="auto">
  <name>Task 3: Scope cloud testing requirements</name>
  <files>docs/GAP_ANALYSIS.md</files>
  <action>
Add cloud testing scope section to docs/GAP_ANALYSIS.md (GAP-03):

1. Section: Cloud Testing Requirements Scope

```markdown
## Cloud Testing Requirements (v2 Scope)

This section scopes the cloud testing requirements for the next milestone. Cloud deployment validation was explicitly deferred from v1.0 to focus on on-premises validation first.

### AWS Testing Requirements

#### CLOUD-01: AWS CloudFormation Deployment
**Objective:** Validate CloudFormation template deploys functional Velociraptor
**Test Scope:**
- Stack creation completes without errors
- EC2 instance is accessible
- Velociraptor API responds to health checks
- Agent enrollment works
- Stack deletion cleans up all resources

**Infrastructure Needed:**
- AWS account with CloudFormation permissions
- VPC with internet gateway (or NAT)
- EC2 launch permissions
- S3 bucket for state (optional)

**Estimated Test Duration:** 15-30 minutes per full cycle

### Azure Testing Requirements

#### CLOUD-02: Azure ARM Template Deployment
**Objective:** Validate ARM template deploys functional Velociraptor
**Test Scope:**
- Resource group deployment completes
- VM is accessible
- Velociraptor API responds
- Agent enrollment works
- Resource group deletion cleans up

**Infrastructure Needed:**
- Azure subscription with contributor role
- Virtual network permissions
- VM deployment permissions

**Estimated Test Duration:** 15-30 minutes per full cycle

### Cross-Cloud Requirements

#### CLOUD-03: Cross-Cloud Consistency
**Objective:** Verify consistent behavior across cloud providers
**Test Scope:**
- Same Velociraptor version deployed
- Same API configuration
- Same agent enrollment process
- Equivalent cleanup behavior

### Test Automation Considerations

**CI/CD Integration:**
- Cloud tests should run in isolated pipelines (cost)
- Use spot/preemptible instances where possible
- Implement cost controls (budget alerts)
- Run on schedule (not every commit)

**Skip Guards:**
- Skip AWS tests if AWS_ACCESS_KEY_ID not set
- Skip Azure tests if AZURE_SUBSCRIPTION_ID not set
- Provide mock mode for local development

### Estimated Resource Requirements

| Provider | Instance Type | Est. Cost/Test | Monthly Budget |
|----------|---------------|----------------|----------------|
| AWS | t3.medium | $0.10-0.20 | $50 |
| Azure | Standard_B2s | $0.10-0.20 | $50 |

### Dependencies on v1.0

Cloud testing depends on:
- [x] Docker deployment validation complete
- [x] Binary deployment code paths tested
- [x] Agent deployment mechanisms validated
- [ ] Deployment state persistence (recommended first)
```

2. Be explicit that this is SCOPING, not implementation.

3. Include infrastructure requirements and cost estimates.
  </action>
  <verify>
grep "## Cloud Testing Requirements" docs/GAP_ANALYSIS.md
grep "CLOUD-01" docs/GAP_ANALYSIS.md
grep "CLOUD-02" docs/GAP_ANALYSIS.md
All should return matches
  </verify>
  <done>
GAP-03: Cloud testing requirements scoped for next milestone.
  </done>
</task>

</tasks>

<verification>
1. docs/GAP_ANALYSIS.md exists with all three major sections
2. Tool capability gaps identified with workflow-based assessment (GAP-01)
3. Deployment recommendations documented with priorities (GAP-02)
4. Cloud testing requirements scoped with infrastructure needs (GAP-03)
5. Document is actionable for v2 planning
</verification>

<success_criteria>
- docs/GAP_ANALYSIS.md is comprehensive (>200 lines)
- Tool gaps identified systematically by workflow category
- At least 5 deployment improvement recommendations with rationale
- Cloud testing scope includes AWS, Azure, and cross-cloud requirements
- Document is suitable for v2 milestone planning
- GAP-01, GAP-02, GAP-03 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/06-deployment-gap-analysis/06-04-SUMMARY.md`
</output>
