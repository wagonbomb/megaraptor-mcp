---
phase: 03-error-handling
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/megaraptor_mcp/tools/hunts.py
  - src/megaraptor_mcp/tools/flows.py
  - src/megaraptor_mcp/tools/vql.py
autonomous: true

must_haves:
  truths:
    - "create_hunt with invalid parameters returns validation error"
    - "get_hunt_results with non-existent hunt returns 404-style error"
    - "get_flow_status with non-existent flow returns 404-style error with hint"
    - "run_vql with malformed syntax returns VQL-specific error hints"
    - "run_vql with trailing semicolon gets pre-emptive validation error"
  artifacts:
    - path: "src/megaraptor_mcp/tools/hunts.py"
      provides: "Hunt tools with full error handling"
      contains: "validate_hunt_id"
    - path: "src/megaraptor_mcp/tools/flows.py"
      provides: "Flow tools with full error handling"
      contains: "validate_flow_id"
    - path: "src/megaraptor_mcp/tools/vql.py"
      provides: "VQL tool with syntax validation and error hints"
      contains: "extract_vql_error_hint"
  key_links:
    - from: "src/megaraptor_mcp/tools/vql.py"
      to: "src/megaraptor_mcp/error_handling/vql_helpers.py"
      via: "import and call extract_vql_error_hint"
      pattern: "extract_vql_error_hint"
    - from: "src/megaraptor_mcp/tools/flows.py"
      to: "src/megaraptor_mcp/error_handling/validators.py"
      via: "import validate_flow_id"
      pattern: "validate_flow_id"
---

<objective>
Add comprehensive error handling to hunts.py, flows.py, and enhance vql.py with VQL-specific error hints.

Purpose: Complete error handling for the remaining core tools. VQL tool especially benefits from syntax validation and hint extraction for common mistakes.

Output: hunts.py, flows.py with full error handling. vql.py enhanced with pre-execution syntax validation and server error hint extraction.
</objective>

<execution_context>
@C:\Users\Meow\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Meow\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-error-handling/03-RESEARCH.md
@.planning/phases/03-error-handling/03-01-SUMMARY.md
@src/megaraptor_mcp/tools/hunts.py
@src/megaraptor_mcp/tools/flows.py
@src/megaraptor_mcp/tools/vql.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add error handling to hunts.py</name>
  <files>src/megaraptor_mcp/tools/hunts.py</files>
  <action>
1. Add imports at top:
   ```python
   import grpc
   from ..error_handling import (
       validate_hunt_id,
       validate_limit,
       map_grpc_error,
   )
   ```

2. Create local validation for hunt-specific parameters if needed

3. Wrap `create_hunt()` in try/except:
   - Validate artifacts list is non-empty
   - Validate description is non-empty
   - Validate timeout > 0
   - Validate expires_hours > 0
   - Validate os_filter if provided: must be 'windows', 'linux', or 'darwin'
   - Wrap client.query() in grpc.RpcError handler -> map_grpc_error(e, "creating hunt")
   - Enhance "Failed to create hunt" error with hint

4. Wrap `list_hunts()` in try/except:
   - Validate limit
   - Validate state if provided: must be 'RUNNING', 'PAUSED', 'STOPPED', 'COMPLETED'
   - Wrap client.query() in grpc.RpcError handler

5. Wrap `get_hunt_results()` in try/except:
   - Validate hunt_id at start: `hunt_id = validate_hunt_id(hunt_id)`
   - Validate limit
   - Wrap client.query() in grpc.RpcError handler
   - If results empty, consider returning informational message (hunt may still be running)

6. Wrap `modify_hunt()` in try/except:
   - Validate hunt_id
   - Existing action validation is good - enhance error message
   - Wrap client.query() in grpc.RpcError handler

Pattern: validation -> grpc.RpcError catch -> ValueError catch -> generic Exception catch (no internals)
  </action>
  <verify>
    python -c "from megaraptor_mcp.tools.hunts import create_hunt, list_hunts, get_hunt_results, modify_hunt; print('hunts.py OK')"
  </verify>
  <done>All 4 hunt tools have input validation and gRPC error handling</done>
</task>

<task type="auto">
  <name>Task 2: Add error handling to flows.py</name>
  <files>src/megaraptor_mcp/tools/flows.py</files>
  <action>
1. Add imports at top:
   ```python
   import grpc
   from ..error_handling import (
       validate_client_id,
       validate_flow_id,
       validate_limit,
       map_grpc_error,
   )
   ```

2. Wrap `list_flows()` in try/except:
   - Validate client_id at start
   - Validate limit
   - Wrap client.query() in grpc.RpcError handler -> map_grpc_error(e, f"listing flows for {client_id}")

3. Wrap `get_flow_results()` in try/except:
   - Validate client_id
   - Validate flow_id
   - Validate limit
   - Wrap client.query() in grpc.RpcError handler
   - If results empty, return informational message (flow may be running, or source not yet available)

4. Wrap `get_flow_status()` in try/except:
   - Validate client_id
   - Validate flow_id
   - Existing "not found" check is good - enhance with hint:
     ```python
     if not results:
         return [TextContent(type="text", text=json.dumps({
             "error": f"Flow not found: {flow_id}",
             "hint": f"Flow does not exist for client {client_id}. Use 'list_flows' to see available flows.",
             "resource_type": "flow",
             "resource_id": flow_id,
             "client_id": client_id,
         }, indent=2))]
     ```
   - Wrap client.query() in grpc.RpcError handler

5. Wrap `cancel_flow()` in try/except:
   - Validate client_id
   - Validate flow_id
   - Wrap client.query() in grpc.RpcError handler
  </action>
  <verify>
    python -c "from megaraptor_mcp.tools.flows import list_flows, get_flow_results, get_flow_status, cancel_flow; print('flows.py OK')"
  </verify>
  <done>All 4 flow tools have input validation and gRPC error handling</done>
</task>

<task type="auto">
  <name>Task 3: Enhance vql.py with syntax validation and error hints</name>
  <files>src/megaraptor_mcp/tools/vql.py</files>
  <action>
1. Add imports at top:
   ```python
   import grpc
   from ..error_handling import (
       validate_vql_syntax_basics,
       validate_limit,
       map_grpc_error,
       extract_vql_error_hint,
   )
   ```

2. Enhance `run_vql()`:
   - Validate query with validate_vql_syntax_basics() BEFORE execution - catches obvious mistakes early
   - Validate max_rows with validate_limit()
   - Keep existing try/except but improve it:
     ```python
     try:
         query = validate_vql_syntax_basics(query)
         max_rows = validate_limit(max_rows, min_val=1, max_val=100000)
         # ... existing code ...
     except ValueError as e:
         # Pre-execution validation error
         return [TextContent(type="text", text=json.dumps({
             "error": str(e),
             "query": query,
         }, indent=2))]
     except grpc.RpcError as e:
         # gRPC error - might be VQL syntax error from server
         error_response = map_grpc_error(e, "executing VQL query")

         # Try to extract VQL-specific hint for INVALID_ARGUMENT
         if e.code() == grpc.StatusCode.INVALID_ARGUMENT:
             error_details = e.details() if hasattr(e, 'details') else ""
             vql_hint = extract_vql_error_hint(error_details)
             error_response["vql_hint"] = vql_hint

         error_response["query"] = query
         return [TextContent(type="text", text=json.dumps(error_response, indent=2))]
     except Exception:
         return [TextContent(type="text", text=json.dumps({
             "error": "Unexpected error executing VQL",
             "hint": "Check server logs for details.",
             "query": query,
         }, indent=2))]
     ```

3. `vql_help()` is already simple and doesn't need much change - just ensure it can't fail unexpectedly

The key improvement: VQL errors now get specific hints like "VQL doesn't use semicolons" or "Check plugin name spelling"
  </action>
  <verify>
    python -c "from megaraptor_mcp.tools.vql import run_vql, vql_help; print('vql.py OK')"
  </verify>
  <done>run_vql has pre-execution syntax validation and VQL-specific error hints from server errors</done>
</task>

</tasks>

<verification>
1. All imports work without errors
2. VQL with trailing semicolon gets validation error BEFORE execution
3. Non-existent hunt/flow returns 404-style error with hint
4. Invalid hunt_id/flow_id format returns validation error
5. gRPC errors mapped to user-friendly messages
</verification>

<success_criteria>
- hunts.py has error handling for all 4 tools
- flows.py has error handling for all 4 tools
- vql.py has pre-execution syntax validation (catches semicolons, empty queries)
- VQL server errors get parsed for hints (symbol not found, syntax error)
- All error responses include hints
- No stack traces exposed
</success_criteria>

<output>
After completion, create `.planning/phases/03-error-handling/03-03-SUMMARY.md`
</output>
