---
phase: 03-error-handling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/megaraptor_mcp/error_handling/__init__.py
  - src/megaraptor_mcp/error_handling/validators.py
  - src/megaraptor_mcp/error_handling/grpc_handlers.py
  - src/megaraptor_mcp/error_handling/vql_helpers.py
  - src/megaraptor_mcp/client.py
autonomous: true

must_haves:
  truths:
    - "gRPC errors are mapped to user-friendly messages with hints"
    - "Transient errors (UNAVAILABLE, DEADLINE_EXCEEDED) trigger automatic retry"
    - "Input validators exist for client_id, limit, hunt_id, flow_id, VQL syntax"
    - "VQL error messages from server are parsed into actionable hints"
  artifacts:
    - path: "src/megaraptor_mcp/error_handling/__init__.py"
      provides: "Module exports for error handling utilities"
      exports: ["validate_client_id", "validate_limit", "validate_vql_syntax_basics", "map_grpc_error", "is_retryable_grpc_error", "extract_vql_error_hint"]
    - path: "src/megaraptor_mcp/error_handling/validators.py"
      provides: "Input validation functions"
      min_lines: 50
    - path: "src/megaraptor_mcp/error_handling/grpc_handlers.py"
      provides: "gRPC StatusCode to user message mapping"
      min_lines: 60
    - path: "src/megaraptor_mcp/error_handling/vql_helpers.py"
      provides: "VQL error hint extraction"
      min_lines: 30
    - path: "src/megaraptor_mcp/client.py"
      provides: "Enhanced client with retry and timeout"
      contains: "@retry"
  key_links:
    - from: "src/megaraptor_mcp/client.py"
      to: "tenacity"
      via: "retry decorator on query method"
      pattern: "@retry.*retry_if_exception"
    - from: "src/megaraptor_mcp/error_handling/grpc_handlers.py"
      to: "grpc.StatusCode"
      via: "status code mapping dict"
      pattern: "grpc\\.StatusCode\\."
---

<objective>
Create the error handling foundation module with validators, gRPC error mapping, VQL hint extraction, and client retry logic.

Purpose: Provides shared utilities that all MCP tools will use for consistent, user-friendly error handling. The client gains retry capability for transient failures.

Output: New `error_handling/` module with validators, grpc_handlers, and vql_helpers. Enhanced client.py with tenacity retry decorator and timeout parameter.
</objective>

<execution_context>
@C:\Users\Meow\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Meow\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-error-handling/03-RESEARCH.md
@src/megaraptor_mcp/client.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tenacity dependency and create error_handling module</name>
  <files>
    pyproject.toml
    src/megaraptor_mcp/error_handling/__init__.py
    src/megaraptor_mcp/error_handling/validators.py
    src/megaraptor_mcp/error_handling/grpc_handlers.py
    src/megaraptor_mcp/error_handling/vql_helpers.py
  </files>
  <action>
1. Add `tenacity>=8.2.3` to pyproject.toml dependencies list (after grpcio-tools)

2. Create `src/megaraptor_mcp/error_handling/` directory with `__init__.py`

3. Create `validators.py` with functions:
   - `validate_client_id(client_id: str) -> str`: Check non-empty, starts with "C.", return validated or raise ValueError with hint
   - `validate_limit(limit: int, min_val: int = 1, max_val: int = 10000) -> int`: Check range, raise ValueError with clear message
   - `validate_hunt_id(hunt_id: str) -> str`: Check non-empty, starts with "H.", return validated or raise ValueError
   - `validate_flow_id(flow_id: str) -> str`: Check non-empty, starts with "F.", return validated or raise ValueError
   - `validate_vql_syntax_basics(query: str) -> str`: Check non-empty, no trailing semicolon (VQL doesn't use them), contains SELECT. Raise ValueError with VQL-specific hints.

4. Create `grpc_handlers.py` with:
   - `is_retryable_grpc_error(exception) -> bool`: Return True for UNAVAILABLE, DEADLINE_EXCEEDED, RESOURCE_EXHAUSTED
   - `map_grpc_error(error: grpc.RpcError, operation: str) -> dict`: Map StatusCode to {"error": "...", "hint": "...", "grpc_status": "..."}
   - Cover: UNAVAILABLE, DEADLINE_EXCEEDED, NOT_FOUND, INVALID_ARGUMENT, UNAUTHENTICATED, PERMISSION_DENIED, INTERNAL
   - Default fallback for unmapped codes

5. Create `vql_helpers.py` with:
   - `extract_vql_error_hint(error_message: str) -> str`: Pattern match common VQL errors:
     - "symbol not found" -> suggest checking plugin name, use vql_help
     - "syntax error" -> common VQL issues (no semicolons, keyword arguments)
     - "expected )" -> parentheses balance
     - "let" + "select" -> LET must be separate statement
     - Default: suggest vql_help(topic="syntax")

6. Update `__init__.py` to export all functions for convenient import

Do NOT use bare except. All functions have specific exception types or return values.
  </action>
  <verify>
    python -c "from megaraptor_mcp.error_handling import validate_client_id, validate_limit, map_grpc_error, extract_vql_error_hint; print('Imports OK')"
  </verify>
  <done>All error handling utilities importable from megaraptor_mcp.error_handling</done>
</task>

<task type="auto">
  <name>Task 2: Enhance client.py with retry and timeout</name>
  <files>src/megaraptor_mcp/client.py</files>
  <action>
1. Add imports at top:
   ```python
   from tenacity import retry, stop_after_attempt, wait_exponential, retry_if_exception
   from .error_handling import is_retryable_grpc_error
   ```

2. Add `@retry` decorator to `query()` method:
   ```python
   @retry(
       retry=retry_if_exception(is_retryable_grpc_error),
       wait=wait_exponential(multiplier=1, min=1, max=10),
       stop=stop_after_attempt(3),
       reraise=True,
   )
   def query(self, vql: str, env=None, org_id=None, timeout: float = 30.0) -> list[dict]:
   ```

3. Add `timeout` parameter with default 30.0 seconds

4. Pass timeout to gRPC call: `self._stub.Query(request, timeout=timeout)`

5. Update docstring to document:
   - Automatic retry on transient failures (UNAVAILABLE, DEADLINE_EXCEEDED, RESOURCE_EXHAUSTED)
   - 3 attempts with exponential backoff (1s, 2s, 4s)
   - No retry on validation errors, auth errors, not found
   - timeout parameter

6. Do the same for `query_stream()` method - add @retry decorator and timeout parameter

Keep all existing functionality. Only ADD retry decorator and timeout parameter.
  </action>
  <verify>
    python -c "from megaraptor_mcp.client import VelociraptorClient; import inspect; sig = inspect.signature(VelociraptorClient.query); assert 'timeout' in sig.parameters, 'No timeout param'; print('Client enhanced OK')"
  </verify>
  <done>client.query() has @retry decorator with exponential backoff and timeout parameter</done>
</task>

<task type="auto">
  <name>Task 3: Unit tests for error handling utilities</name>
  <files>tests/unit/test_error_handling.py</files>
  <action>
1. Create `tests/unit/test_error_handling.py` with pytest tests:

Test validators:
- `test_validate_client_id_valid()`: "C.1234" passes
- `test_validate_client_id_empty()`: "" raises ValueError with "cannot be empty"
- `test_validate_client_id_invalid_format()`: "invalid" raises ValueError with "Must start with 'C.'"
- `test_validate_limit_valid()`: 100 passes
- `test_validate_limit_negative()`: -1 raises ValueError with "at least"
- `test_validate_limit_too_large()`: 100001 raises ValueError with "cannot exceed"
- `test_validate_vql_syntax_empty()`: "" raises ValueError
- `test_validate_vql_syntax_semicolon()`: "SELECT * FROM info();" raises ValueError with "semicolon"
- `test_validate_vql_syntax_no_select()`: "FROM info()" raises ValueError with "SELECT"

Test grpc_handlers:
- `test_is_retryable_unavailable()`: Mock grpc.RpcError with UNAVAILABLE -> True
- `test_is_retryable_not_found()`: Mock grpc.RpcError with NOT_FOUND -> False
- `test_map_grpc_error_unavailable()`: Returns error dict with "unavailable" and helpful hint
- `test_map_grpc_error_timeout()`: DEADLINE_EXCEEDED returns timeout message
- `test_map_grpc_error_not_found()`: NOT_FOUND returns 404-style message
- `test_map_grpc_error_auth()`: UNAUTHENTICATED returns auth error without stack trace

Test vql_helpers:
- `test_vql_hint_symbol_not_found()`: "symbol X not found" -> hint about plugin name
- `test_vql_hint_syntax_error()`: "syntax error" -> hint about VQL differences
- `test_vql_hint_let_in_select()`: "LET cannot appear in SELECT" -> hint about LET statement

Use pytest fixtures and mock grpc errors. Mark as unit tests: `@pytest.mark.unit`
  </action>
  <verify>
    cd "C:\Users\Meow\Documents\Projects\megaraptor-mcp" && python -m pytest tests/unit/test_error_handling.py -v
  </verify>
  <done>All unit tests pass for validators, grpc_handlers, and vql_helpers</done>
</task>

</tasks>

<verification>
1. `pip install -e .` installs without errors (tenacity added)
2. All error_handling functions importable
3. client.query() has timeout parameter and @retry decorator
4. Unit tests pass: `pytest tests/unit/test_error_handling.py -v`
</verification>

<success_criteria>
- tenacity>=8.2.3 in pyproject.toml dependencies
- error_handling module exists with validators.py, grpc_handlers.py, vql_helpers.py
- client.py has @retry decorator on query() and query_stream()
- client.py has timeout parameter defaulting to 30.0
- All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-error-handling/03-01-SUMMARY.md`
</output>
