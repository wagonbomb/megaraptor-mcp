---
phase: 03-error-handling
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/megaraptor_mcp/tools/clients.py
  - src/megaraptor_mcp/tools/artifacts.py
autonomous: true

must_haves:
  truths:
    - "list_clients with negative limit returns validation error, not crash"
    - "get_client_info with invalid client_id returns clear format error"
    - "get_client_info with non-existent client returns 404-style error with hint"
    - "collect_artifact gRPC errors are mapped to user-friendly messages"
    - "No stack traces appear in any error response"
  artifacts:
    - path: "src/megaraptor_mcp/tools/clients.py"
      provides: "Client tools with full error handling"
      contains: "validate_client_id"
    - path: "src/megaraptor_mcp/tools/artifacts.py"
      provides: "Artifact tools with full error handling"
      contains: "map_grpc_error"
  key_links:
    - from: "src/megaraptor_mcp/tools/clients.py"
      to: "src/megaraptor_mcp/error_handling/validators.py"
      via: "import and call validate_client_id"
      pattern: "from.*error_handling.*import.*validate"
    - from: "src/megaraptor_mcp/tools/clients.py"
      to: "src/megaraptor_mcp/error_handling/grpc_handlers.py"
      via: "import and call map_grpc_error"
      pattern: "map_grpc_error"
---

<objective>
Add comprehensive error handling to clients.py and artifacts.py tools.

Purpose: These are the most frequently used tools. Users calling list_clients, get_client_info, list_artifacts, collect_artifact will get clear, actionable error messages instead of crashes or cryptic errors.

Output: clients.py and artifacts.py with input validation, gRPC error handling, and 404-style errors for missing resources.
</objective>

<execution_context>
@C:\Users\Meow\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Meow\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-error-handling/03-RESEARCH.md
@.planning/phases/03-error-handling/03-01-SUMMARY.md
@src/megaraptor_mcp/tools/clients.py
@src/megaraptor_mcp/tools/artifacts.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add error handling to clients.py</name>
  <files>src/megaraptor_mcp/tools/clients.py</files>
  <action>
1. Add imports at top:
   ```python
   import grpc
   from ..error_handling import (
       validate_client_id,
       validate_limit,
       map_grpc_error,
   )
   ```

2. Wrap `list_clients()` in try/except:
   - Validate limit at start: `limit = validate_limit(limit)`
   - Validate search doesn't contain VQL injection: `if search and (";" in search or "--" in search): return error`
   - Wrap client.query() in try/except grpc.RpcError -> map_grpc_error(e, "listing clients")
   - Catch ValueError for validation errors -> return {"error": str(e), "hint": "..."}
   - Final except Exception -> return generic error WITHOUT str(e) internals

3. Wrap `get_client_info()` in try/except:
   - Validate client_id at start: `client_id = validate_client_id(client_id)`
   - Existing "not found" check already returns JSON error - enhance with hint:
     ```python
     if not results:
         return [TextContent(type="text", text=json.dumps({
             "error": f"Client not found: {client_id}",
             "hint": "Client does not exist or has never connected. Use 'list_clients' to see available clients.",
             "resource_type": "client",
             "resource_id": client_id,
         }, indent=2))]
     ```
   - Wrap client.query() in try/except grpc.RpcError -> map_grpc_error(e, f"fetching client {client_id}")
   - Catch ValueError -> return validation error with hint

4. Wrap `label_client()` in try/except:
   - Validate client_id at start
   - Existing operation validation ("add" or "remove") is fine - enhance error message with valid options
   - Wrap query calls in grpc.RpcError handler

5. Wrap `quarantine_client()` in try/except:
   - Validate client_id at start
   - Wrap query call in grpc.RpcError handler

Pattern for each tool:
```python
try:
    # Validation
    client_id = validate_client_id(client_id)
    # ... rest of function
except grpc.RpcError as e:
    return [TextContent(type="text", text=json.dumps(map_grpc_error(e, "operation description"), indent=2))]
except ValueError as e:
    return [TextContent(type="text", text=json.dumps({"error": str(e), "hint": "Check parameter format."}, indent=2))]
except Exception:
    return [TextContent(type="text", text=json.dumps({"error": "Unexpected error", "hint": "Check server logs."}, indent=2))]
```

Do NOT include str(e) in generic Exception handler - this exposes stack traces.
  </action>
  <verify>
    python -c "from megaraptor_mcp.tools.clients import list_clients, get_client_info; print('clients.py OK')"
  </verify>
  <done>All 4 client tools have input validation, gRPC error handling, and 404-style errors</done>
</task>

<task type="auto">
  <name>Task 2: Add error handling to artifacts.py</name>
  <files>src/megaraptor_mcp/tools/artifacts.py</files>
  <action>
1. Add imports at top:
   ```python
   import grpc
   from ..error_handling import (
       validate_client_id,
       validate_limit,
       map_grpc_error,
   )
   ```

2. Create helper `validate_artifact_name(name: str) -> str`:
   - Check non-empty
   - Check doesn't contain obvious injection patterns
   - Return validated name or raise ValueError

3. Wrap `list_artifacts()` in try/except:
   - Validate limit: `limit = validate_limit(limit)`
   - Wrap client.query() in grpc.RpcError handler -> map_grpc_error(e, "listing artifacts")
   - Generic exception handler without internals

4. Wrap `get_artifact()` in try/except:
   - Validate artifact_name (non-empty)
   - Enhance existing "not found" error with hint:
     ```python
     if not results:
         return [TextContent(type="text", text=json.dumps({
             "error": f"Artifact not found: {artifact_name}",
             "hint": "Artifact does not exist. Use 'list_artifacts' to see available artifacts.",
             "resource_type": "artifact",
             "resource_id": artifact_name,
         }, indent=2))]
     ```
   - Wrap client.query() in grpc.RpcError handler

5. Wrap `collect_artifact()` in try/except:
   - Validate client_id at start
   - Validate each artifact name in list
   - Validate timeout is positive
   - Wrap client.query() in grpc.RpcError handler
   - Enhance existing "Failed to start collection" error with hint

Pattern: Same as clients.py - validation first, then specific exception handlers, then generic fallback.
  </action>
  <verify>
    python -c "from megaraptor_mcp.tools.artifacts import list_artifacts, get_artifact, collect_artifact; print('artifacts.py OK')"
  </verify>
  <done>All 3 artifact tools have input validation, gRPC error handling, and 404-style errors</done>
</task>

<task type="auto">
  <name>Task 3: Integration tests for client and artifact error handling</name>
  <files>tests/integration/test_error_handling_clients_artifacts.py</files>
  <action>
1. Create integration test file that tests error scenarios against real (or mocked) server

2. Test client tool errors (mark as @pytest.mark.integration):
   - `test_list_clients_negative_limit()`: Call list_clients(limit=-1), assert returns JSON with "error" key, no stack trace
   - `test_get_client_info_invalid_format()`: Call get_client_info("not-a-client"), assert error mentions "C." format
   - `test_get_client_info_nonexistent()`: Call get_client_info("C.nonexistent123"), assert 404-style error with hint
   - `test_label_client_invalid_operation()`: Call label_client("C.x", ["test"], operation="invalid"), assert error lists valid operations

3. Test artifact tool errors:
   - `test_list_artifacts_negative_limit()`: Call list_artifacts(limit=-1), assert validation error
   - `test_get_artifact_nonexistent()`: Call get_artifact("Nonexistent.Artifact.Name"), assert 404-style error with hint
   - `test_collect_artifact_invalid_client()`: Call collect_artifact("bad-id", ["Generic.Client.Info"]), assert client_id validation error

4. Test that no stack traces appear:
   - For each error response, assert "Traceback" not in response
   - Assert "File " not in response (Python path pattern)

5. Use pytest-check for soft assertions where appropriate to see all failures

These tests can run against real Velociraptor if available, or mock the client for unit-style testing.
  </action>
  <verify>
    cd "C:\Users\Meow\Documents\Projects\megaraptor-mcp" && python -m pytest tests/integration/test_error_handling_clients_artifacts.py -v --timeout=60
  </verify>
  <done>Integration tests verify error handling for clients and artifacts tools</done>
</task>

</tasks>

<verification>
1. `python -c "from megaraptor_mcp.tools.clients import *"` - no errors
2. `python -c "from megaraptor_mcp.tools.artifacts import *"` - no errors
3. Integration tests pass
4. No stack traces in any error response
</verification>

<success_criteria>
- clients.py has error handling for all 4 tools (list_clients, get_client_info, label_client, quarantine_client)
- artifacts.py has error handling for all 3 tools (list_artifacts, get_artifact, collect_artifact)
- Invalid client_id format returns clear validation error
- Non-existent resources return 404-style errors with hints
- gRPC errors are mapped to user-friendly messages
- No stack traces exposed in any error response
</success_criteria>

<output>
After completion, create `.planning/phases/03-error-handling/03-02-SUMMARY.md`
</output>
