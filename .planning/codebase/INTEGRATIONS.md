# External Integrations

**Analysis Date:** 2026-01-24

## APIs & External Services

**Velociraptor DFIR Platform:**
- Velociraptor - Enterprise DFIR and endpoint interrogation platform
  - SDK/Client: `pyvelociraptor` with gRPC stubs `api_pb2` and `api_pb2_grpc`
  - Auth: Mutual TLS (mTLS) with client certificates
  - Connection: gRPC over TLS to API URL (configurable endpoint)
  - Files: `src/megaraptor_mcp/client.py` (VelociraptorClient wrapper), `src/megaraptor_mcp/config.py` (VelociraptorConfig)

**VQL Query Execution:**
- Velociraptor Query Language (VQL) - Custom query language for artifact collection and forensics
  - Methods: `client.query()` and `client.query_stream()` in `src/megaraptor_mcp/client.py`
  - Communication: Streaming JSON responses via gRPC `Query()` method
  - Files: `src/megaraptor_mcp/tools/vql.py` (run_vql, vql_help tools)

## Data Storage

**Databases:**
- None - Megaraptor itself is stateless. Velociraptor backend uses FileBaseDataStore
  - Client: VelociraptorClient connects to remote Velociraptor server
  - Data model: Velociraptor maintains all persistent state (clients, hunts, flows, artifacts)

**File Storage:**
- Local filesystem only - For deployments and certificates
  - Deployment data: `~/.local/share/megaraptor-mcp/deployments/` (Linux) or `%LOCALAPPDATA%\megaraptor-mcp\deployments\` (Windows)
  - Certificates: Stored in deployment-specific directories as PEM files
  - Credential store: Encrypted JSON file at `~/.local/share/megaraptor-mcp/credentials.enc` (AES-256-GCM)
  - Files: `src/megaraptor_mcp/deployment/deployers/base.py` (BaseDeployer storage management)

**Caching:**
- None configured - Each request to Velociraptor is fresh

## Authentication & Identity

**Auth Provider:**
- Mutual TLS (mTLS) - Custom certificate-based authentication
  - Implementation: SSL/TLS credentials via `grpcio.ssl_channel_credentials()`
  - Source: Client certificates generated by Velociraptor or provided via env vars/config file
  - Config loading: `src/megaraptor_mcp/config.py` - `VelociraptorConfig.from_config_file()` or `from_env()`
  - Certificate validation: gRPC handles TLS handshake with CA cert validation
  - Files: `src/megaraptor_mcp/client.py` (lines 83-116: `_create_channel()`)

**Credential Storage:**
- AES-256-GCM encrypted credential store for deployment secrets
  - Implementation: PBKDF2-SHA256 key derivation (600,000 iterations) + AES-256-GCM
  - Secrets stored: SSH keys, WinRM passwords, API tokens for deployment systems
  - Files: `src/megaraptor_mcp/deployment/security/credential_store.py`

## Monitoring & Observability

**Error Tracking:**
- None detected - Uses standard Python logging

**Logs:**
- Standard Python logging to stderr
  - Format: `"%(asctime)s - %(name)s - %(levelname)s - %(message)s"`
  - Logger: `logging.getLogger("megaraptor-mcp")`
  - Files: `src/megaraptor_mcp/server.py` (lines 27-33)

## CI/CD & Deployment

**Hosting:**
- Not determined - Can run anywhere Python 3.10+ is available
- Designed as MCP server to be run by Claude AI or other MCP clients via stdio transport

**CI Pipeline:**
- Not detected in codebase - No GitHub Actions, GitLab CI, or similar configs found

**Deployment Automation:**
- Docker Deployer: `src/megaraptor_mcp/deployment/deployers/docker_deployer.py`
  - Uses `docker` Python SDK to run Velociraptor in containers
  - Image: `velocidex/velociraptor:latest` from Docker Hub
  - Supports resource limits, port mappings, volume mounts, restart policies

- AWS CloudFormation Deployer: `src/megaraptor_mcp/deployment/deployers/cloud_deployer.py` (AWSDeployer)
  - Uses `boto3` CloudFormation and EC2 clients
  - Region: Configurable (default: us-east-1)
  - Generates YAML CloudFormation templates with EC2 instance resources
  - Supports auto-destroy scheduling via CloudFormation stack lifecycle

- Azure ARM Deployer: `src/megaraptor_mcp/deployment/deployers/cloud_deployer.py` (AzureDeployer)
  - Uses Azure SDK (`azure-mgmt-resource`, `azure-identity`)
  - Authentication: DefaultAzureCredential for automated Azure CLI integration
  - Generates JSON ARM templates for resource deployment

- SSH Deployer: `src/megaraptor_mcp/deployment/agents/ssh_deployer.py`
  - Uses `paramiko` for SSH connections
  - Supports key-based and password authentication
  - Deploys Velociraptor agents to Linux/macOS endpoints

- WinRM Deployer: `src/megaraptor_mcp/deployment/agents/winrm_deployer.py`
  - Uses `pywinrm` for remote Windows management
  - Deploys agents to Windows endpoints via PowerShell remoting

- Binary Deployer: `src/megaraptor_mcp/deployment/deployers/binary_deployer.py`
  - Manual binary deployment support with configuration generation
  - Useful for on-premises or restricted environments

## Environment Configuration

**Required env vars:**
- VELOCIRAPTOR_CONFIG_PATH (Option 1): Path to Velociraptor API client config file
  - Example: `/home/user/.velociraptor/api_client.yaml`
- OR Option 2 (all four):
  - VELOCIRAPTOR_API_URL: gRPC API endpoint (e.g., `https://velociraptor.example.com:8889`)
  - VELOCIRAPTOR_CLIENT_CERT: Client certificate PEM content or file path
  - VELOCIRAPTOR_CLIENT_KEY: Client private key PEM content or file path
  - VELOCIRAPTOR_CA_CERT: CA certificate PEM content or file path

**Optional env vars:**
- AZURE_SUBSCRIPTION_ID: Azure subscription ID for cloud deployments

**Secrets location:**
- Credential store: `~/.local/share/megaraptor-mcp/credentials.enc` (encrypted with AES-256-GCM)
  - Encryption key: Either from `~/.local/share/megaraptor-mcp/key.bin` or derived from master password
  - Files: `src/megaraptor_mcp/deployment/security/credential_store.py`

- Deployment certificates: Stored unencrypted in deployment directories
  - Location: `{storage_path}/{deployment_id}/certs/`
  - Lifecycle: Generated by `src/megaraptor_mcp/deployment/security/certificate_manager.py`

## Webhooks & Callbacks

**Incoming:**
- None detected

**Outgoing:**
- Health checks via HTTP: `httpx.AsyncClient` makes GET requests to deployment API URLs
  - Used in: `src/megaraptor_mcp/deployment/deployers/docker_deployer.py` and `cloud_deployer.py`
  - Purpose: Verify Velociraptor server responsiveness post-deployment
  - SSL verification: Disabled (`verify=False`) for self-signed certificates

## MCP Protocol Integration

**Server Transport:**
- stdio (standard input/output) via `mcp.server.stdio.stdio_server()`
  - Used by Claude and other MCP clients for communication
  - Files: `src/megaraptor_mcp/server.py` (lines 77-83)

**Resources Exposed:**
- `velociraptor://clients` - List Velociraptor endpoints
- `velociraptor://clients/{client_id}` - Specific client details
- `velociraptor://hunts` - Threat hunting campaigns
- `velociraptor://hunts/{hunt_id}` - Specific hunt details
- `velociraptor://artifacts` - Available forensic artifacts
- `velociraptor://server-info` - Velociraptor server information
- `velociraptor://deployments` - Deployment operations and status
- Files: `src/megaraptor_mcp/resources/` (resource registration)

**Tools Exposed:**
- 33 tools total: 15 DFIR tools + 18 deployment tools
  - DFIR: client/artifact/hunt/flow/VQL management
  - Deployment: server/agent deployment, credential management, health verification
  - Files: `src/megaraptor_mcp/tools/` (clients.py, artifacts.py, hunts.py, flows.py, vql.py, deployment.py)

**Prompts Exposed:**
- 8 pre-built workflow prompts for DFIR and deployment scenarios
- Files: `src/megaraptor_mcp/prompts/prompts.py`

## Summary of External Dependencies

| Service | Type | Required | Optional | Purpose |
|---------|------|----------|----------|---------|
| Velociraptor Server | DFIR API | Yes | - | Core forensics and endpoint data |
| Docker | Container | - | deployment | Server containerization |
| AWS CloudFormation | IaaS | - | cloud | EC2 infrastructure deployment |
| Azure Resource Manager | IaaS | - | cloud | VM infrastructure deployment |
| SSH/Paramiko | Remote Exec | - | deployment | Linux/macOS agent deployment |
| WinRM/pywinrm | Remote Exec | - | deployment | Windows endpoint management |
| Docker Hub | Registry | - | deployment | Pulls `velocidex/velociraptor` image |

---

*Integration audit: 2026-01-24*
