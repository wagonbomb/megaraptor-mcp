# Test infrastructure for megaraptor-mcp integration tests
#
# Usage:
#   docker compose -f tests/docker-compose.test.yml up -d
#   docker compose -f tests/docker-compose.test.yml down -v
#
# Prerequisites:
#   1. Generate server config first (see scripts/test-lab.sh generate-config)
#   2. Ensure fixtures/server.config.yaml and fixtures/client.config.yaml exist

services:
  velociraptor-server:
    image: wlambert/velociraptor:latest
    container_name: vr-test-server
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        cp /opt/velociraptor/linux/velociraptor /tmp/velociraptor && chmod +x /tmp/velociraptor
        /tmp/velociraptor --config /config/server.config.yaml frontend -v
    volumes:
      - vr-server-data:/data
      - ./fixtures:/config:ro
    ports:
      - "18889:8889"  # GUI
      - "18000:8000"  # Frontend (client connections)
      - "18001:8001"  # API (gRPC)
    healthcheck:
      test: ["CMD-SHELL", "curl -ks https://localhost:8889/ | grep -q 'Redirect' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    networks:
      - vr-test-net
    restart: unless-stopped

  velociraptor-client:
    image: wlambert/velociraptor:latest
    container_name: vr-test-client
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        cp /opt/velociraptor/linux/velociraptor /tmp/velociraptor && chmod +x /tmp/velociraptor
        /tmp/velociraptor --config /config/client.config.yaml client -v
    volumes:
      - ./fixtures:/config:ro
    depends_on:
      velociraptor-server:
        condition: service_healthy
    networks:
      - vr-test-net
    restart: unless-stopped

volumes:
  vr-server-data:
    name: vr-test-server-data

networks:
  vr-test-net:
    driver: bridge
    name: vr-test-network
