# Test infrastructure for megaraptor-mcp integration tests
#
# Usage:
#   docker compose -f tests/docker-compose.test.yml up -d
#   docker compose -f tests/docker-compose.test.yml down -v
#
# Prerequisites:
#   1. Generate server config first (see scripts/test-lab.sh generate-config)
#   2. Ensure fixtures/server.config.yaml and fixtures/client.config.yaml exist

services:
  velociraptor-server:
    image: velocidex/velociraptor:latest
    container_name: vr-test-server
    command:
      - "frontend"
      - "--config"
      - "/config/server.config.yaml"
      - "-v"
    volumes:
      - vr-server-data:/data
      - ./fixtures:/config:ro
    ports:
      - "8889:8889"   # GUI
      - "8000:8000"   # Frontend (client connections)
      - "8001:8001"   # API (gRPC)
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:8889/app/index.html || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - vr-test-net
    restart: unless-stopped

  velociraptor-client:
    image: velocidex/velociraptor:latest
    container_name: vr-test-client
    command:
      - "client"
      - "--config"
      - "/config/client.config.yaml"
      - "-v"
    volumes:
      - ./fixtures:/config:ro
    depends_on:
      velociraptor-server:
        condition: service_healthy
    networks:
      - vr-test-net
    restart: unless-stopped

volumes:
  vr-server-data:
    name: vr-test-server-data

networks:
  vr-test-net:
    driver: bridge
    name: vr-test-network
